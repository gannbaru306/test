<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MusicXML → ドレミ付きPDF（完全版）</title>
<style>
  body { font-family: sans-serif; background: #f4f6fa; padding: 1em; text-align: center; }
  #scoreContainer { background: #fff; border: 1px solid #ccc; margin: 1em auto; padding: 1em; max-width: 900px; }
  #status { background: #fff; border: 1px solid #ddd; padding: .5em; margin: 1em auto; max-width: 900px; text-align: left; height: 160px; overflow: auto; white-space: pre-line; }
  input, button { padding: .6em 1em; margin: .4em; }
</style>
</head>
<body>
  <h1>XML → ドレミ付き楽譜（A4高画質PDF対応）</h1>

  <div>
    <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
    <button id="loadBtn">読み込み</button>
    <button id="pdfBtn">PDF保存</button>
  </div>

  <div id="status">初期化中...</div>
  <div id="scoreContainer"></div>

  <!-- 必須ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.7.6/build/opensheetmusicdisplay.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(function(){
  const log = msg => {
    const el = document.getElementById("status");
    el.textContent = new Date().toLocaleTimeString() + " — " + msg + "\n" + el.textContent;
    console.log(msg);
  };

  const wait = setInterval(() => {
    if (window.opensheetmusicdisplay?.OpenSheetMusicDisplay) {
      clearInterval(wait);
      log("OSMD 読み込み完了。初期化開始。");
      initApp();
    } else log("OSMD 待機中...");
  }, 500);

  function toDoremi(step, alter, octave) {
    const base = { C: "ド", D: "レ", E: "ミ", F: "ファ", G: "ソ", A: "ラ", B: "シ" };
    let name = base[step] || step;
    if (alter === 1) name += "#";
    if (alter === -1) name += "♭";
    return name + "
